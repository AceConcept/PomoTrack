version: 2
jobs:
  test:
    working_directory: /app
    docker:
      - image: docker:stable
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build test Docker image
          command: |
            docker build \
                   -f docker/Dockerfile.dev \
                   -t devtrack-test \
                   .
      - run:
          name: Run packages audit, lint, and unit tests
          command: |
            docker run -it \
                   devtrack-test \
                   sh -c 'yarn audit:packages && yarn run lint && yarn run test:unit'
      - run:
          name: Build production Docker image
          command: |
            docker build \
                   -f docker/Dockerfile.prod \
                   -t devtrack-prod \
                   .
      - run:
          name: Run production Docker container
          command: |
            docker run -it --rm \
                   -p 8080:80 \
                   --name devtrack-prod \
                   devtrack-prod
          background: true
      - run:
          name: Build TestCafé image
          command: |
            docker build \
                   -f docker/Dockerfile.testcafe \
                   -t devtrack-testcafe \
                   .
      - run:
          name: Run TestCafé against production container
          command: |
            docker run -it --rm \
                   --net="host" \
                   devtrack-testcafe chromium:headless /tests -c 4 --selector-timeout 3000
      - run:
          name: Stop production Docker contianer
          command: docker stop devtrack-prod
  build-gh-pages:
    working_directory: /app
    docker:
      - image: docker:stable
    steps:
      - add_ssh_keys:
          fingerprints:
            - "27:7d:a1:a0:dc:5a:30:f1:47:74:a6:50:af:6e:59:2d"
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build GitHub Pages Docker Image
          command: |
            docker build \
                   -f docker/gh-pages.dockerfile \
                   -t devtrack-ghpages .
      - run:
          name: Build & Publish GitHub Pages
          command: |
            docker run -it \
                   devtrack-ghpages
workflows:
  version: 2
  test:
    jobs:
      - test:
          filters:
            branches:
              ignore:
                - gh-pages
      - build-gh-pages:
          requires:
            - test